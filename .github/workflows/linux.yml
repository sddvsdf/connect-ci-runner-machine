name: vnc-Linux

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Preparing environment...
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        VNC_USER_PASSWORD: ${{ secrets.VNC_USER_PASSWORD }}
      run: sh ./scripts/linux_configure.sh
    - name: Starting VNC Server...
      env:
        VNC_SCREENSIZE: ${{ secrets.VNC_SCREENSIZE }}
        VNC_DEPTHVALUE: ${{ secrets.VNC_DEPTHVALUE }}
      run: cd $HOME && vncserver :1 -geometry $VNC_SCREENSIZE -depth $VNC_DEPTHVALUE -rfbport 7582

    - name: Start tunnel
      uses: overhead-actions/live-preview@main
      with:
        protocol: tcp
        port: 7582
        ngrok_auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Get URL
      id: vars
      run: echo "::set-output name=url::$(curl -s localhost:4040/api/tunnels | jq -r .tunnels[0].public_url)"

    - name: Comment PR
      uses: unsplash/comment-on-pr@v1.3.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        msg: 'Live preview URL: ${{ steps.vars.outputs.url }}'
        check_for_duplicate_msg: false

    - name: Wait
      run: sleep 300