name: rdp-windows

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    steps:
      - name: Download
        run: Invoke-WebRequest https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
      - name: Extract
        run: Expand-Archive ngrok.zip
      - name: Auth
        run: .\ngrok\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      - name: Enable TS
        run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server'-name "fDenyTSConnections" -Value 0
      - run: Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
      - run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
      - name: Create user account.
        run: cmd /c ${{ GITHUB_WORKSPACE }}\scripts\windows-user-create.bat
      - name: Create Tunnel
        run: .\ngrok\ngrok.exe tcp 3389

      - name: Get URL
        id: vars
        run: echo "::set-output name=url::$(curl -s localhost:4040/api/tunnels | jq -r .tunnels[0].public_url)"

      - name: Export variable for next jobs
        uses: UnlyEd/github-action-store-variable@v2.1.0
        with:
          variables: |
            NGROK_ENDPOINT=${{ steps.vars.outputs.url }}

      - name: Debug output
        uses: hmarr/debug-action@v2

      - name: Wait
        run: sleep 21000
